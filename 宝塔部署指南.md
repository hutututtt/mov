# 宝塔面板部署指南

## 服务器信息
- **服务器IP**: 1.116.113.209
- **端口**: 3000
- **访问地址**: http://1.116.113.209:3000

## 部署步骤

### 1. 上传项目文件
1. 将整个 `mov` 文件夹上传到服务器的 `/opt/` 目录
2. 确保文件权限正确：
   ```bash
   chown -R www:www /opt/mov
   chmod -R 755 /opt/mov
   ```

### 2. 安装 Node.js 环境
1. 在宝塔面板中安装 Node.js 版本管理器
2. 安装 Node.js 14+ 版本
3. 全局安装 PM2：
   ```bash
   npm install -g pm2
   ```

### 3. 安装项目依赖
```bash
cd /opt/mov
npm install --production
```

### 4. 配置 Nginx
1. 在宝塔面板中创建网站，绑定域名或IP：`1.116.113.209`
2. 将 `nginx-simple.conf` 的内容复制到网站配置中
3. 配置中的路径已设置为：`/opt/mov`
4. 重启 Nginx

### 5. 启动应用
```bash
cd /opt/mov
npm run pm2:start
```

### 6. 设置开机自启
```bash
pm2 startup
pm2 save
```

## 常用命令

### PM2 管理命令
```bash
# 启动应用
npm run pm2:start

# 停止应用
npm run pm2:stop

# 重启应用
npm run pm2:restart

# 重载应用（零停机）
npm run pm2:reload

# 删除应用
npm run pm2:delete

# 查看日志
npm run pm2:logs

# 监控面板
npm run pm2:monit
```

### 查看应用状态
```bash
pm2 status
pm2 list
```

## 故障排除

### 1. 端口占用问题
```bash
# 查看端口占用
netstat -tlnp | grep 3000
lsof -i :3000

# 杀死占用进程
kill -9 <PID>
```

### 2. 权限问题
```bash
# 修复文件权限
chown -R www:www /opt/mov
chmod -R 755 /opt/mov
```

### 3. Nginx 400 错误
- 检查 Nginx 配置中的代理设置
- 确保 `proxy_buffering off` 和 `proxy_request_buffering off` 已设置
- 检查请求头大小限制

### 4. 应用无法启动
```bash
# 查看详细错误日志
pm2 logs movie-streaming-platform --lines 100

# 检查 Node.js 版本
node --version
npm --version
```

## 性能优化建议

1. **内存限制**: PM2 配置中设置了 512MB 内存限制，可根据服务器配置调整
2. **日志管理**: 定期清理日志文件，避免磁盘空间不足
3. **监控**: 使用 `pm2 monit` 监控应用状态
4. **备份**: 定期备份项目文件和数据库

## 安全建议

1. 定期更新依赖包
2. 设置防火墙规则
3. 使用 HTTPS（如需要）
4. 定期检查日志文件

## 更新部署

当需要更新代码时：
```bash
cd /opt/mov
git pull origin main  # 如果使用 Git
npm install --production
npm run pm2:reload
```

## 联系信息
如有问题，请检查日志文件或联系管理员。
